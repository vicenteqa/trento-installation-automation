trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: terraformVersion
    value: '1.6.0'
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)'

stages:
  - stage: TerraformProvision
    displayName: 'Provision Azure Infrastructure'
    jobs:
      - job: TerraformApply
        displayName: 'Terraform Init and Apply'
        steps:
          - checkout: self
            displayName: 'Checkout Repository'

          - task: TerraformInstaller@1
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '$(terraformVersion)'

          - task: AzureCLI@2
            displayName: 'Set Azure Subscription ID'
            inputs:
              azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID]$SUBSCRIPTION_ID"
                echo "Azure Subscription ID: $SUBSCRIPTION_ID"

          - task: Bash@3
            displayName: 'Export Terraform Variables'
            inputs:
              targetType: 'inline'
              script: |
                # Export Terraform variables from pipeline variables
                echo "##vso[task.setvariable variable=TF_VAR_azure_resource_group]$(AZURE_RESOURCE_GROUP)"
                echo "##vso[task.setvariable variable=TF_VAR_azure_vms_location]$(AZURE_VMS_LOCATION)"
                echo "##vso[task.setvariable variable=TF_VAR_azure_owner_tag]$(AZURE_OWNER_TAG)"
                echo "##vso[task.setvariable variable=TF_VAR_ssh_user]$(SSH_USER)"

                echo "Terraform variables exported successfully"

          - task: AzureCLI@2
            displayName: 'Terraform Init'
            inputs:
              azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(workingDirectory)/terraform'
              addSpnToEnvironment: true
              inlineScript: |
                set -euo pipefail

                # Set Azure credentials for Terraform
                export ARM_CLIENT_ID=$servicePrincipalId
                export ARM_CLIENT_SECRET=$servicePrincipalKey
                export ARM_TENANT_ID=$tenantId
                export ARM_SUBSCRIPTION_ID=$(ARM_SUBSCRIPTION_ID)

                # Initialize Terraform
                terraform init

          - task: AzureCLI@2
            displayName: 'Terraform Apply'
            inputs:
              azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(workingDirectory)/terraform'
              addSpnToEnvironment: true
              inlineScript: |
                set -euo pipefail

                # Set Azure credentials for Terraform
                export ARM_CLIENT_ID=$servicePrincipalId
                export ARM_CLIENT_SECRET=$servicePrincipalKey
                export ARM_TENANT_ID=$tenantId
                export ARM_SUBSCRIPTION_ID=$(ARM_SUBSCRIPTION_ID)

                # Export Terraform variables
                export TF_VAR_azure_resource_group="$(AZURE_RESOURCE_GROUP)"
                export TF_VAR_azure_vms_location="$(AZURE_VMS_LOCATION)"
                export TF_VAR_azure_owner_tag="$(AZURE_OWNER_TAG)"
                export TF_VAR_ssh_user="$(SSH_USER)"

                # Apply Terraform configuration
                terraform apply -auto-approve

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Terraform Logs'
            condition: always()
            inputs:
              PathtoPublish: '$(workingDirectory)/logs'
              ArtifactName: 'terraform-logs'
              publishLocation: 'Container'
